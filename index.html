<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Internal ERP</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#111827;
      --line:#e5e7eb;
      --btn:#111827;
      --btnText:#ffffff;
      --soft:#f9fafb;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:22px auto;padding:0 14px}
    h1{margin:0 0 6px 0;font-size:26px}
    .sub{color:var(--muted);font-size:13px;margin:0 0 14px 0}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0 16px}
    .tab{
      border:1px solid var(--line);
      background:var(--card);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
    }
    .tab.active{background:var(--text);color:#fff;border-color:var(--text)}
    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:var(--card);
      padding:18px;
      box-shadow:0 1px 0 rgba(0,0,0,.02);
    }
    .sectionTitle{font-size:20px;margin:0 0 14px 0}
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:12px;
    }
    @media(max-width:900px){
      .grid{grid-template-columns: repeat(2, minmax(0,1fr));}
    }
    @media(max-width:520px){
      .grid{grid-template-columns: 1fr;}
    }
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input, select, textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    input[readonly]{background:var(--soft)}
    textarea{min-height:40px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{
      border:0;
      background:var(--btn);
      color:var(--btnText);
      padding:11px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      min-width:160px;
    }
    .btn.secondary{
      background:#fff;
      color:var(--text);
      border:1px solid var(--line);
      font-weight:700;
      min-width:auto;
    }
    .right{display:flex;justify-content:flex-end}
    .muted{color:var(--muted);font-size:12px}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .hide{display:none}
    .pill{
      display:inline-block;
      padding:4px 8px;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      background:var(--soft);
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      text-align:left;
      vertical-align:top;
    }
    th{background:var(--soft);font-size:12px;color:var(--muted)}
    tr:last-child td{border-bottom:0}
    .small{font-size:12px}
    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--soft);
      font-size:12px;
      white-space:pre-wrap;
    }
    .itemsBox{
      border:1px solid var(--line);
      background:var(--soft);
      border-radius:12px;
      padding:12px;
    }
    .itemsHead{
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .itemsList{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .itemRow{
      display:grid;
      grid-template-columns: 2fr 1fr 1fr 0.8fr 1fr 0.6fr;
      gap:8px;
      align-items:center;
    }
    @media(max-width:900px){
      .itemRow{grid-template-columns:1fr 1fr;gap:10px;}
    }
    .itemRow .removeBtn{
      background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px;cursor:pointer;
      font-weight:700;
    }
    .totalBox{
      display:flex;justify-content:flex-end;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px;
    }
    .totalBox .totalVal{font-weight:800;font-size:16px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Internal ERP</h1>
    <p class="sub">Stable · Lists are read-only (edit in Google Sheet → Lists tab)</p>

    <div class="tabs">
      <button class="tab active" data-tab="inv">Inventory IN</button>
      <button class="tab" data-tab="sales">Sales</button>
      <button class="tab" data-tab="exp">Expenses</button>
      <button class="tab" data-tab="dash">Dashboard</button>
    </div>

    <!-- Inventory IN -->
    <div id="tab-inv" class="card">
      <h2 class="sectionTitle">Inventory IN</h2>

      <div class="grid">
        <div>
          <label>Date (yyyy-mm-dd)</label>
          <input id="inv_date" type="date" />
        </div>
        <div>
          <label>Warehouse / Location</label>
          <select id="inv_location"></select>
        </div>
        <div>
          <label>Product Category</label>
          <select id="inv_prod_cat"></select>
        </div>
        <div>
          <label>Product Name</label>
          <input id="inv_product" type="text" placeholder="Name" />
        </div>

        <div>
          <label>Color</label>
          <select id="inv_color"></select>
        </div>
        <div>
          <label>Size</label>
          <select id="inv_size"></select>
        </div>
        <div>
          <label>Qty</label>
          <input id="inv_qty" type="number" min="0" step="1" value="0"/>
        </div>
        <div>
          <label>Unit Price (RMB)</label>
          <input id="inv_unit_rmb" type="number" min="0" step="0.01" value="0.00"/>
        </div>

        <div>
          <label>FX (RMB / USD)</label>
          <input id="inv_fx" type="number" min="0.01" step="0.01" value="7.20"/>
        </div>
        <div>
          <label>Unit Price (USD) auto</label>
          <input id="inv_unit_usd" type="text" readonly />
        </div>
        <div>
          <label>Amount (USD) auto</label>
          <input id="inv_amt_usd" type="text" readonly />
        </div>
        <div>
          <label>Note</label>
          <input id="inv_note" type="text" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <span class="muted">USD calc uses 2 decimals: unit_usd = unit_rmb / fx</span>
      </div>

      <div class="right" style="margin-top:14px">
        <button class="btn" id="btn_save_inv">Save Inventory IN</button>
      </div>

      <div class="msg" id="inv_msg" style="display:none"></div>
    </div>

    <!-- Sales -->
    <div id="tab-sales" class="card hide">
      <h2 class="sectionTitle">Sales</h2>

      <div class="grid">
        <div>
          <label>Order Date (yyyy-mm-dd)</label>
          <input id="so_date" type="date"/>
        </div>
        <div>
          <label>Warehouse / Location</label>
          <select id="so_location"></select>
        </div>
        <div>
          <label>Customer Name</label>
          <input id="so_customer" type="text" placeholder="Customer"/>
        </div>
        <div>
          <label>Telephone</label>
          <input id="so_tel" type="text" placeholder="Phone"/>
        </div>

        <div>
          <label>Customer Address</label>
          <input id="so_addr" type="text" placeholder="Address"/>
        </div>
        <div>
          <label>Delivery Company</label>
          <select id="so_delivery"></select>
        </div>
        <div>
          <label>Currency</label>
          <select id="so_currency">
            <option value="USD">USD</option>
            <option value="KHR">KHR</option>
          </select>
        </div>
        <div>
          <label>Cash Timing</label>
          <select id="so_cash_timing">
            <option value="BEFORE">BEFORE delivery</option>
            <option value="AFTER">AFTER delivery</option>
          </select>
        </div>

        <div>
          <label>Paid Amount</label>
          <input id="so_paid" type="number" min="0" step="0.01" value="0"/>
        </div>
        <div>
          <label>Note</label>
          <input id="so_note" type="text"/>
        </div>
      </div>

      <div class="hr"></div>

      <div class="itemsBox">
        <div class="itemsHead">
          <div class="row">
            <strong>Items</strong>
            <span class="pill">multi-items</span>
          </div>
          <button class="btn secondary" id="btn_add_item">+ Add Item</button>
        </div>

        <div class="itemsList" id="items_list"></div>

        <div class="totalBox">
          <span class="muted">Total:</span>
          <span class="totalVal" id="so_total">0.00</span>
        </div>
      </div>

      <div class="right" style="margin-top:14px;gap:10px;display:flex">
        <button class="btn secondary" id="btn_print_last">Print Last Saved</button>
        <button class="btn" id="btn_save_sale">Save Sale</button>
      </div>

      <div class="msg" id="sales_msg" style="display:none"></div>

      <div class="hr"></div>

      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:10px">
        <div>
          <strong>Recent Orders</strong>
          <div class="muted">Update Status and Paid Amount after saving. Print includes customer details.</div>
        </div>
        <button class="btn secondary" id="btn_refresh_orders">Refresh Orders</button>
      </div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Customer</th>
              <th>Order ID</th>
              <th>Date</th>
              <th>Total</th>
              <th>Paid</th>
              <th>Payment</th>
              <th>Status</th>
              <th>Update Paid</th>
              <th></th>
              <th>Print</th>
            </tr>
          </thead>
          <tbody id="orders_tbody">
            <tr><td colspan="10" class="muted small">No data yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Expenses -->
    <div id="tab-exp" class="card hide">
      <h2 class="sectionTitle">Expenses</h2>

      <div class="grid">
        <div>
          <label>Date (yyyy-mm-dd)</label>
          <input id="ex_date" type="date"/>
        </div>
        <div>
          <label>Warehouse / Location</label>
          <select id="ex_location"></select>
        </div>
        <div>
          <label>Expense Category</label>
          <select id="ex_cat"></select>
        </div>
        <div>
          <label>Currency</label>
          <select id="ex_currency">
            <option value="USD">USD</option>
            <option value="KHR">KHR</option>
          </select>
        </div>

        <div>
          <label>Amount</label>
          <input id="ex_amount" type="number" step="0.01" min="0" value="0.00"/>
        </div>
        <div>
          <label>Note</label>
          <input id="ex_note" type="text"/>
        </div>
      </div>

      <div class="right" style="margin-top:14px">
        <button class="btn" id="btn_save_exp">Save Expense</button>
      </div>

      <div class="msg" id="exp_msg" style="display:none"></div>
    </div>

    <!-- Dashboard -->
    <div id="tab-dash" class="card hide">
      <h2 class="sectionTitle">Dashboard</h2>

      <div class="grid">
        <div>
          <label>From</label>
          <input id="dash_from" type="date"/>
        </div>
        <div>
          <label>To</label>
          <input id="dash_to" type="date"/>
        </div>
        <div class="right" style="align-items:end">
          <button class="btn" id="btn_dash_run">Run</button>
        </div>
      </div>

      <div class="hr"></div>

      <div id="dash_out" class="muted">Select date range then Run.</div>

      <div class="msg" id="dash_msg" style="display:none"></div>
    </div>

  </div>

<script>
  // ✅ HARD-CODED API URL (Updated)
  const API_BASE = "https://script.google.com/macros/s/AKfycbwG8vVTeulbTBhlDJr2WzpX4xZ64rw-kRINssJAlrg5DpjADqqmr2D_U2Kj5Mlsp3x5/exec";

  // ---------- helpers ----------
  const $ = (id)=>document.getElementById(id);
  const fmt2 = (n)=> (isFinite(n)? Number(n).toFixed(2) : "0.00");
  const todayISO = ()=> {
    const d = new Date();
    const pad = (x)=> String(x).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  };

  function showMsg(el, obj, isErr=false){
    el.style.display = "block";
    el.style.borderColor = isErr ? "#ef4444" : "#e5e7eb";
    el.textContent = (typeof obj === "string") ? obj : JSON.stringify(obj, null, 2);
  }

  // JSONP fetch (works with GAS web apps / GitHub Pages safely)
  function jsonp(url, timeoutMs=15000){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const s = document.createElement("script");
      const timer = setTimeout(()=>{
        cleanup();
        reject(new Error("Timeout"));
      }, timeoutMs);

      function cleanup(){
        clearTimeout(timer);
        delete window[cb];
        if(s && s.parentNode) s.parentNode.removeChild(s);
      }

      window[cb] = (data)=>{
        cleanup();
        resolve(data);
      };

      const sep = url.includes("?") ? "&" : "?";
      s.src = url + sep + "callback=" + cb;
      s.onerror = ()=>{
        cleanup();
        reject(new Error("Network error"));
      };
      document.body.appendChild(s);
    });
  }

  async function apiGet(action, params={}){
    const qs = new URLSearchParams({ action, ...params }).toString();
    const url = API_BASE + "?" + qs;
    return await jsonp(url);
  }

  async function apiPost(action, payload){
    // Many GAS setups accept POST JSON; but GitHub Pages + CORS can be painful.
    // We'll send as GET with payload=... if backend supports it.
    // If your backend already supports POST, keep it. If not, GET fallback makes it stable.
    const packed = encodeURIComponent(JSON.stringify(payload || {}));
    return await apiGet(action, { payload: packed });
  }

  function fillSelect(sel, arr, placeholder="Select..."){
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder;
    sel.appendChild(opt0);
    (arr||[]).forEach(v=>{
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      sel.appendChild(o);
    });
  }

  // ---------- tabs ----------
  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const t = btn.dataset.tab;
      ["inv","sales","exp","dash"].forEach(x=>{
        $("tab-"+x).classList.toggle("hide", x!==t);
      });
    });
  });

  // ---------- lists ----------
  let LISTS = {};
  async function loadLists(){
    const res = await apiGet("get_lists");
    if(!res || !res.ok) throw new Error(res?.message || "get_lists failed");
    LISTS = res.data || {};

    fillSelect($("inv_location"), LISTS.LOCATION, "Select location");
    fillSelect($("inv_prod_cat"), LISTS.PROD_CAT, "Select category");
    fillSelect($("inv_color"), LISTS.PROD_COLOR, "Select color");
    fillSelect($("inv_size"), LISTS.PROD_SIZE, "Select size");

    fillSelect($("so_location"), LISTS.LOCATION, "Select location");
    fillSelect($("so_delivery"), LISTS.DELIVERY_COMPANY, "Select delivery company");

    fillSelect($("ex_location"), LISTS.LOCATION, "Select location");
    fillSelect($("ex_cat"), LISTS.EXP_CAT, "Select expense category");
  }

  // ---------- Inventory IN calc ----------
  function recalcInv(){
    const qty = Number($("inv_qty").value || 0);
    const unitRmb = Number($("inv_unit_rmb").value || 0);
    const fx = Number($("inv_fx").value || 0);
    const unitUsd = fx>0 ? (unitRmb / fx) : 0;
    const amtUsd = unitUsd * qty;
    $("inv_unit_usd").value = fmt2(unitUsd);
    $("inv_amt_usd").value = fmt2(amtUsd);
  }

  ["inv_qty","inv_unit_rmb","inv_fx"].forEach(id=>{
    $(id).addEventListener("input", recalcInv);
  });

  // ---------- Inventory IN save ----------
  $("btn_save_inv").addEventListener("click", async ()=>{
    const msgEl = $("inv_msg");
    msgEl.style.display = "none";
    try{
      const payload = {
        date: $("inv_date").value,
        location: $("inv_location").value,
        prod_cat: $("inv_prod_cat").value,
        product: $("inv_product").value.trim(),
        color: $("inv_color").value,
        size: $("inv_size").value,
        qty: Number($("inv_qty").value || 0),
        unit_rmb: Number($("inv_unit_rmb").value || 0),
        fx: Number($("inv_fx").value || 0),
        unit_usd: Number($("inv_unit_usd").value || 0),
        amount_usd: Number($("inv_amt_usd").value || 0),
        note: $("inv_note").value.trim()
      };
      const res = await apiPost("save_inventory_in", payload);
      if(!res || !res.ok) throw new Error(res?.message || "save_inventory_in failed");
      showMsg(msgEl, res, false);
    }catch(err){
      showMsg($("inv_msg"), "ERROR: " + err.message, true);
    }
  });

  // ---------- Sales items UI ----------
  let lastSavedOrderId = null;

  function makeItemRow(){
    const row = document.createElement("div");
    row.className = "itemRow";

    const sku = document.createElement("input");
    sku.placeholder = "Product";
    sku.title = "Product";
    const color = document.createElement("select");
    const size = document.createElement("select");
    const qty = document.createElement("input");
    qty.type="number"; qty.min="0"; qty.step="1"; qty.value="1";
    const unit = document.createElement("input");
    unit.type="number"; unit.min="0"; unit.step="0.01"; unit.value="0.00";

    const remove = document.createElement("button");
    remove.className="removeBtn";
    remove.type="button";
    remove.textContent="X";

    fillSelect(color, LISTS.PROD_COLOR, "Color");
    fillSelect(size, LISTS.PROD_SIZE, "Size");

    function recalc(){
      const lt = Number(qty.value||0) * Number(unit.value||0);
      row.dataset.lineTotal = String(lt);
      recalcSaleTotal();
    }
    qty.addEventListener("input", recalc);
    unit.addEventListener("input", recalc);

    remove.addEventListener("click", ()=>{
      row.remove();
      recalcSaleTotal();
    });

    row.appendChild(sku);
    row.appendChild(color);
    row.appendChild(size);
    row.appendChild(qty);
    row.appendChild(unit);
    row.appendChild(remove);

    return row;
  }

  function recalcSaleTotal(){
    const rows = [...$("items_list").children];
    const total = rows.reduce((s,r)=> s + Number(r.dataset.lineTotal||0), 0);
    $("so_total").textContent = fmt2(total);
  }

  $("btn_add_item").addEventListener("click", ()=>{
    $("items_list").appendChild(makeItemRow());
    recalcSaleTotal();
  });

  // ---------- Sales save ----------
  $("btn_save_sale").addEventListener("click", async ()=>{
    const msgEl = $("sales_msg");
    msgEl.style.display = "none";
    try{
      const itemRows = [...$("items_list").children];
      if(itemRows.length === 0) throw new Error("Please add at least 1 item");

      const items = itemRows.map(r=>{
        const [sku, color, size, qty, unit] = r.querySelectorAll("input,select");
        const q = Number(qty.value||0);
        const u = Number(unit.value||0);
        return {
          sku: sku.value.trim() || "MIXED items",
          color: color.value || "",
          size: size.value || "",
          qty: q,
          unit_price: u,
          line_total: q*u
        };
      });

      const total = items.reduce((s,it)=> s + Number(it.line_total||0), 0);
      const paid = Number($("so_paid").value || 0);
      const payload = {
        order_date: $("so_date").value,
        location: $("so_location").value,
        customer: $("so_customer").value.trim(),
        telephone: $("so_tel").value.trim(),
        address: $("so_addr").value.trim(),
        delivery_company: $("so_delivery").value,
        currency: $("so_currency").value,
        cash_timing: $("so_cash_timing").value,
        paid_amount: paid,
        total: total,
        note: $("so_note").value.trim(),
        items
      };

      const res = await apiPost("save_sale", payload);
      if(!res || !res.ok) throw new Error(res?.message || "save_sale failed");
      lastSavedOrderId = res.data?.order_id || null;
      showMsg(msgEl, res, false);
      await refreshOrders();
    }catch(err){
      showMsg($("sales_msg"), "ERROR: " + err.message, true);
    }
  });

  // ---------- Orders list + update + print ----------
  async function refreshOrders(){
    const tbody = $("orders_tbody");
    tbody.innerHTML = `<tr><td colspan="10" class="muted small">Loading...</td></tr>`;
    try{
      const res = await apiGet("get_recent_orders", { limit: 20 });
      if(!res || !res.ok) throw new Error(res?.message || "get_recent_orders failed");
      const rows = res.data || [];
      if(rows.length === 0){
        tbody.innerHTML = `<tr><td colspan="10" class="muted small">No data yet</td></tr>`;
        return;
      }

      tbody.innerHTML = "";
      rows.forEach(o=>{
        const tr = document.createElement("tr");

        const customer = o.customer_name || o.customer || "";
        const orderId = o.order_id || "";
        const date = (o.order_date || o.date || "").toString();
        const total = Number(o.total ?? o.grand_total ?? 0);
        const paid = Number(o.paid_amount ?? o.paid ?? 0);
        const payStatus = o.payment_status || "";
        const status = o.status || "NEW";

        tr.innerHTML = `
          <td>${escapeHtml(customer)}</td>
          <td class="small">${escapeHtml(orderId)}</td>
          <td class="small">${escapeHtml(date)}</td>
          <td>${fmt2(total)}</td>
          <td>${fmt2(paid)}</td>
          <td>${escapeHtml(payStatus)}</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        `;

        // Status dropdown
        const tdStatus = tr.children[6];
        const sel = document.createElement("select");
        ["NEW","PREPARED","DELIVERING","COMPLETED","CANCELLED"].forEach(s=>{
          const op=document.createElement("option");
          op.value=s; op.textContent=s;
          if(s===status) op.selected=true;
          sel.appendChild(op);
        });
        sel.addEventListener("change", async ()=>{
          try{
            const r = await apiPost("update_order_status", { order_id: orderId, status: sel.value });
            if(!r || !r.ok) throw new Error(r?.message || "update_order_status failed");
          }catch(e){
            alert("Status update failed:\n" + e.message);
            sel.value = status;
          }
        });
        tdStatus.appendChild(sel);

        // Paid amount update
        const tdPaid = tr.children[7];
        const paidInput = document.createElement("input");
        paidInput.type="number"; paidInput.min="0"; paidInput.step="0.01";
        paidInput.value = fmt2(paid);
        tdPaid.appendChild(paidInput);

        const tdUpd = tr.children[8];
        const btnUpd = document.createElement("button");
        btnUpd.className="btn secondary";
        btnUpd.style.padding="8px 10px";
        btnUpd.style.minWidth="auto";
        btnUpd.textContent="Update";
        btnUpd.addEventListener("click", async ()=>{
          try{
            const r = await apiPost("update_sale_payment", { order_id: orderId, paid_amount: Number(paidInput.value||0) });
            if(!r || !r.ok) throw new Error(r?.message || "update_sale_payment failed");
            await refreshOrders();
          }catch(e){
            alert("Payment update failed:\n" + e.message);
          }
        });
        tdUpd.appendChild(btnUpd);

        // Print
        const tdPrint = tr.children[9];
        const btnPrint = document.createElement("button");
        btnPrint.className="btn secondary";
        btnPrint.style.padding="8px 10px";
        btnPrint.style.minWidth="auto";
        btnPrint.textContent="Print";
        btnPrint.addEventListener("click", ()=> printOrder(orderId));
        tdPrint.appendChild(btnPrint);

        tbody.appendChild(tr);
      });
    }catch(err){
      tbody.innerHTML = `<tr><td colspan="10" class="muted small">ERROR: ${escapeHtml(err.message)}</td></tr>`;
    }
  }

  $("btn_refresh_orders").addEventListener("click", refreshOrders);

  $("btn_print_last").addEventListener("click", ()=>{
    if(!lastSavedOrderId){
      alert("No last saved order yet.");
      return;
    }
    printOrder(lastSavedOrderId);
  });

  async function printOrder(orderId){
    try{
      const res = await apiGet("get_order_detail", { order_id: orderId });
      if(!res || !res.ok) throw new Error(res?.message || "get_order_detail failed");
      const o = res.data?.order || res.order || res.data || {};
      const items = res.data?.items || o.items || [];

      const html = buildPackingSlipHtml(o, items);
      const w = window.open("", "_blank");
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.focus();
      w.print();
    }catch(e){
      alert("Print failed:\n" + e.message);
    }
  }

  function buildPackingSlipHtml(order, items){
    const orderId = order.order_id || "";
    const date = order.order_date || order.date || "";
    const customer = order.customer_name || order.customer || "";
    const tel = order.telephone || order.tel || "";
    const addr = order.customer_address || order.address || "";
    const loc = order.location || "";
    const del = order.delivery_company || "";
    const cur = order.currency || "USD";
    const status = order.status || "";
    const total = fmt2(Number(order.total ?? order.grand_total ?? 0));
    const note = order.note || "";

    const rows = (items && items.length)
      ? items.map(it=>`
          <tr>
            <td>${escapeHtml(it.sku || it.prod_name || it.product || "Item")}</td>
            <td>${escapeHtml(it.prod_color || it.color || "")}</td>
            <td>${escapeHtml(it.prod_size || it.size || "")}</td>
            <td style="text-align:right">${escapeHtml(String(it.qty ?? ""))}</td>
          </tr>
        `).join("")
      : `<tr><td>MIXED items</td><td></td><td></td><td style="text-align:right"></td></tr>`;

    return `
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Packing Slip ${escapeHtml(orderId)}</title>
  <style>
    body{font-family:Arial, sans-serif;margin:18px;color:#111}
    h2{margin:0 0 10px}
    .box{border:1px solid #ddd;border-radius:10px;padding:12px;margin-bottom:12px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #ddd;padding:8px;font-size:12px}
    th{background:#f6f6f6;text-align:left}
    .muted{color:#666;font-size:12px}
    .row{display:flex;gap:18px;flex-wrap:wrap}
    .row > div{min-width:240px}
  </style>
</head>
<body>
  <div class="muted">${new Date().toLocaleString()}</div>
  <h2>Packing Slip / Delivery Label</h2>

  <div class="box">
    <div class="row">
      <div>
        <div><strong>Order ID:</strong> ${escapeHtml(orderId)}</div>
        <div><strong>Date:</strong> ${escapeHtml(date)}</div>
        <div><strong>Status:</strong> ${escapeHtml(status)}</div>
        <div><strong>Total:</strong> ${escapeHtml(cur)} ${escapeHtml(total)}</div>
      </div>
      <div>
        <div><strong>Customer:</strong> ${escapeHtml(customer)}</div>
        <div><strong>Tel:</strong> ${escapeHtml(tel)}</div>
        <div><strong>Address:</strong> ${escapeHtml(addr)}</div>
      </div>
      <div>
        <div><strong>Location:</strong> ${escapeHtml(loc)}</div>
        <div><strong>Delivery Company:</strong> ${escapeHtml(del)}</div>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Product</th><th>Color</th><th>Size</th><th style="text-align:right">Qty</th>
        </tr>
      </thead>
      <tbody>
        ${rows}
      </tbody>
    </table>

    <div style="margin-top:10px"><strong>Note:</strong> ${escapeHtml(note)}</div>
  </div>
</body>
</html>`;
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ---------- Expenses save ----------
  $("btn_save_exp").addEventListener("click", async ()=>{
    const msgEl = $("exp_msg");
    msgEl.style.display = "none";
    try{
      const payload = {
        date: $("ex_date").value,
        location: $("ex_location").value,
        category: $("ex_cat").value,
        currency: $("ex_currency").value,
        amount: Number($("ex_amount").value || 0),
        note: $("ex_note").value.trim()
      };
      const res = await apiPost("save_expense", payload);
      if(!res || !res.ok) throw new Error(res?.message || "save_expense failed");
      showMsg(msgEl, res, false);
    }catch(err){
      showMsg($("exp_msg"), "ERROR: " + err.message, true);
    }
  });

  // ---------- Dashboard ----------
  $("btn_dash_run").addEventListener("click", async ()=>{
    const msgEl = $("dash_msg");
    msgEl.style.display="none";
    $("dash_out").textContent = "Loading...";
    try{
      const from = $("dash_from").value;
      const to = $("dash_to").value;
      const res = await apiGet("dashboard", { from, to });
      if(!res || !res.ok){
        $("dash_out").textContent = "Dashboard data not available (backend action=dashboard not implemented).";
        showMsg(msgEl, res || {ok:false}, true);
        return;
      }
      $("dash_out").textContent = "";
      showMsg(msgEl, res, false);
    }catch(err){
      $("dash_out").textContent = "Dashboard data not available.";
      showMsg($("dash_msg"), "ERROR: " + err.message, true);
    }
  });

  // ---------- init ----------
  (async function init(){
    $("inv_date").value = todayISO();
    $("so_date").value = todayISO();
    $("ex_date").value = todayISO();
    $("dash_from").value = todayISO();
    $("dash_to").value = todayISO();

    try{
      await loadLists();
      // start sales items with 1 row
      $("items_list").innerHTML = "";
      $("items_list").appendChild(makeItemRow());
      recalcSaleTotal();
      recalcInv();
      // load orders once
      refreshOrders();
    }catch(e){
      // If lists fail, dropdowns will be empty (still stable, shows message)
      showMsg($("inv_msg"), "ERROR loading lists: " + e.message, true);
      showMsg($("sales_msg"), "ERROR loading lists: " + e.message, true);
      showMsg($("exp_msg"), "ERROR loading lists: " + e.message, true);
    }
  })();
</script>
</body>
</html>
