<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internal ERP</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-light: #64748b;
            --danger: #ef4444;
            --success: #22c55e;
        }

        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
        
        /* Layout */
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 1rem; display: flex; align-items: center; justify-content: space-between; }
        h1 { margin: 0; font-size: 1.25rem; font-weight: 700; color: var(--primary); }
        
        nav { display: flex; gap: 0.5rem; overflow-x: auto; padding: 0.5rem 1rem; background: var(--surface); border-bottom: 1px solid var(--border); }
        .nav-btn { background: none; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; color: var(--text-light); font-weight: 500; white-space: nowrap; }
        .nav-btn.active { background: var(--primary); color: white; }
        
        main { flex: 1; padding: 1.5rem; overflow-y: auto; max-width: 1200px; margin: 0 auto; width: 100%; }
        
        /* Sections */
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s ease; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards & Forms */
        .card { background: var(--surface); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border); }
        .card h2 { margin-top: 0; font-size: 1.1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.75rem; margin-bottom: 1rem; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.35rem; }
        label { font-size: 0.85rem; font-weight: 600; color: var(--text-light); }
        input, select, textarea { padding: 0.6rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.95rem; width: 100%; transition: border 0.2s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1); }
        .readonly { background: #f1f5f9; color: var(--text-light); }
        
        /* Buttons */
        .btn { padding: 0.6rem 1.2rem; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: background 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text); }
        .btn-secondary:hover { background: var(--bg); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        
        /* Tables */
        .table-container { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; white-space: nowrap; }
        th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: #f8fafc; font-weight: 600; color: var(--text-light); }
        tr:last-child td { border-bottom: none; }
        
        /* Financial Report Tables */
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .financial-table th { text-align: right; }
        .financial-table td { text-align: right; }
        .financial-table th:first-child, .financial-table td:first-child { text-align: left; }
        .font-bold { font-weight: 700; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }

        /* Status Badges */
        .badge { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 99px; font-size: 0.75rem; font-weight: 600; }
        .badge-NEW { background: #e0f2fe; color: #0284c7; }
        .badge-PAID { background: #dcfce7; color: #16a34a; }
        .badge-PARTIAL { background: #fef9c3; color: #ca8a04; }
        .badge-UNPAID { background: #fee2e2; color: #dc2626; }
        .badge-DELIVERING { background: #f3e8ff; color: #9333ea; }

        /* Toast */
        #toast-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
        .toast { padding: 1rem; border-radius: 6px; background: #334155; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: slideIn 0.3s ease; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Sales Items Grid */
        .items-header { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 80px 100px 40px; gap: 0.5rem; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.85rem; color: var(--text-light); }
        .items-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 80px 100px 40px; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center; }

        /* Dashboard KPI */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .kpi-card { background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border); }
        .kpi-label { font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.5rem; }
        .kpi-value { font-size: 1.5rem; font-weight: 700; color: var(--text); }
        .kpi-sub { font-size: 0.8rem; margin-top: 0.5rem; }

        /* Print Styles */
        @media print {
            body { background: white; height: auto; overflow: visible; }
            header, nav, .no-print { display: none !important; }
            main { padding: 0; max-width: none; }
            .card { box-shadow: none; border: none; padding: 0; }
            .print-only { display: block !important; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h1>Internal ERP</h1>
        <div style="font-size: 0.8rem; color: var(--text-light);">v1.1</div>
    </header>

    <nav>
        <button class="nav-btn active" onclick="showTab('inventory-in')">Inventory IN</button>
        <button class="nav-btn" onclick="showTab('sales')">Sales Orders</button>
        <button class="nav-btn" onclick="showTab('expenses')">Expenses</button>
        <button class="nav-btn" onclick="showTab('dashboard')">Dashboard</button>
        <button class="nav-btn" onclick="showTab('reports')">Financial Reports</button>
    </nav>

    <main>
        <!-- INVENTORY IN SECTION -->
        <section id="inventory-in" class="section active">
            <div class="card">
                <h2>Receive Stock</h2>
                <form id="form-inventory" onsubmit="handleInventorySubmit(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" name="date" required id="inv-date">
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <select name="location" id="inv-location" required></select>
                        </div>
                        <div class="form-group">
                            <label>Product Category</label>
                            <select name="prod_cat" id="inv-cat" required></select>
                        </div>
                        <div class="form-group">
                            <label>Product Name</label>
                            <input type="text" name="product" placeholder="e.g. Lavender Spray" required>
                        </div>
                        <div class="form-group">
                            <label>Color</label>
                            <select name="color" id="inv-color"></select>
                        </div>
                        <div class="form-group">
                            <label>Size</label>
                            <select name="size" id="inv-size"></select>
                        </div>
                        <div class="form-group">
                            <label>Qty</label>
                            <input type="number" name="qty" min="1" required oninput="calcInvTotal()">
                        </div>
                        <div class="form-group">
                            <label>Unit Price (RMB)</label>
                            <input type="number" name="unit_rmb" step="0.01" required oninput="calcInvTotal()">
                        </div>
                        <div class="form-group">
                            <label>FX Rate (RMB->USD)</label>
                            <input type="number" name="fx" step="0.0001" value="7.2" required oninput="calcInvTotal()">
                        </div>
                        <div class="form-group">
                            <label>Unit Price (USD)</label>
                            <input type="text" name="unit_usd" id="inv-unit-usd" class="readonly" readonly>
                        </div>
                        <div class="form-group">
                            <label>Total Amount (USD)</label>
                            <input type="text" name="amount_usd" id="inv-total-usd" class="readonly" readonly>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 1rem;">
                        <label>Note</label>
                        <textarea name="note" rows="2"></textarea>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button type="submit" class="btn btn-primary">Save Stock IN</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- SALES ORDERS SECTION -->
        <section id="sales" class="section">
            <div id="sales-list-view">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                        <h2 style="margin:0; border:none;">Recent Orders</h2>
                        <button class="btn btn-primary" onclick="showNewOrderForm()">+ New Order</button>
                    </div>
                    <div class="table-container">
                        <table id="sales-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Total (USD)</th>
                                    <th>Paid</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="7" style="text-align:center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="sales-form-view" style="display:none;">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                        <h2 style="margin:0; border:none;">Create New Order</h2>
                        <button class="btn btn-secondary btn-sm" onclick="showSalesList()">Cancel</button>
                    </div>
                    <form id="form-sales" onsubmit="handleSalesSubmit(event)">
                        <input type="hidden" name="order_id" id="sales-order-id">
                        <div class="form-grid">
                            <div class="form-group"><label>Date</label><input type="date" name="order_date" required id="sales-date"></div>
                            <div class="form-group"><label>Location</label><select name="location" id="sales-location" required></select></div>
                            <div class="form-group"><label>Customer Name</label><input type="text" name="customer_name" required></div>
                            <div class="form-group"><label>Phone</label><input type="text" name="telephone"></div>
                            <div class="form-group"><label>Address</label><input type="text" name="customer_address"></div>
                            <div class="form-group"><label>Delivery Co.</label><select name="delivery_company" id="sales-delivery"></select></div>
                            <div class="form-group"><label>Currency</label><select name="currency" id="sales-currency"></select></div>
                            <div class="form-group"><label>Order Total</label><input type="number" step="0.01" id="sales-total" class="readonly" readonly></div>
                            <div class="form-group"><label>Paid Amount</label><input type="number" step="0.01" name="paid_amount" value="0" id="sales-paid"></div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem;"><label>Note</label><textarea name="note" rows="2"></textarea></div>
                        <h3>Items</h3>
                        <div class="items-list" id="sales-items-container"></div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addSalesItemRow()" style="margin-top:0.5rem;">+ Add Item</button>
                        <div style="margin-top: 1.5rem; text-align: right;"><button type="submit" class="btn btn-primary">Create Order</button></div>
                    </form>
                </div>
            </div>
        </section>

        <!-- EXPENSES SECTION -->
        <section id="expenses" class="section">
            <div class="card">
                <h2>Record Expense</h2>
                <form id="form-expense" onsubmit="handleExpenseSubmit(event)">
                    <div class="form-grid">
                        <div class="form-group"><label>Date</label><input type="date" name="date" required id="exp-date"></div>
                        <div class="form-group"><label>Location</label><select name="location" id="exp-location" required></select></div>
                        <div class="form-group"><label>Category</label><select name="category" id="exp-cat" required></select></div>
                        <div class="form-group"><label>Currency</label><select name="currency" id="exp-currency"></select></div>
                        <div class="form-group"><label>Amount</label><input type="number" step="0.01" name="amount" required></div>
                    </div>
                    <div class="form-group" style="margin-top: 1rem;"><label>Note</label><textarea name="note" rows="2"></textarea></div>
                    <div style="margin-top: 1.5rem; text-align: right;"><button type="submit" class="btn btn-primary">Save Expense</button></div>
                </form>
            </div>
        </section>

        <!-- DASHBOARD SECTION -->
        <section id="dashboard" class="section">
            <div class="card">
                <div style="display:flex; gap:1rem; align-items:flex-end; margin-bottom:1.5rem;">
                    <div class="form-group" style="flex:1;"><label>From Date</label><input type="date" id="dash-from"></div>
                    <div class="form-group" style="flex:1;"><label>To Date</label><input type="date" id="dash-to"></div>
                    <div><button class="btn btn-primary" onclick="loadDashboard()">Update Report</button></div>
                </div>
                <div class="kpi-grid">
                    <div class="kpi-card"><div class="kpi-label">Total Sales (USD)</div><div class="kpi-value" id="kpi-sales">0.00</div></div>
                    <div class="kpi-card"><div class="kpi-label">Total Expenses (USD)</div><div class="kpi-value" id="kpi-exp" style="color: var(--danger)">0.00</div></div>
                    <div class="kpi-card"><div class="kpi-label">Net Profit (Est.)</div><div class="kpi-value" id="kpi-profit">0.00</div></div>
                </div>
                <h3>Remaining Inventory Summary</h3>
                <div class="table-container">
                    <table id="inventory-table"><thead><tr><th>Category</th><th>Product</th><th>Color</th><th>Size</th><th>Qty Left</th></tr></thead><tbody><tr><td colspan="5" style="text-align:center">Select dates and click Update</td></tr></tbody></table>
                </div>
            </div>
        </section>

        <!-- FINANCIAL REPORTS SECTION -->
        <section id="reports" class="section">
            <div class="card">
                <h2>Financial Reports (P&L & Balance Sheet)</h2>
                <div style="display:flex; gap:1rem; align-items:flex-end; margin-bottom:1.5rem;">
                    <div class="form-group" style="flex:1;">
                        <label>Report Start Date</label>
                        <input type="date" id="fin-from">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label>Report End Date</label>
                        <input type="date" id="fin-to">
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="loadFinancialReports()">Generate Report</button>
                    </div>
                </div>

                <div class="report-grid">
                    <!-- Profit & Loss -->
                    <div class="card" style="margin-bottom:0;">
                        <h3>Profit & Loss Statement</h3>
                        <div style="font-size:0.85rem; color:var(--text-light); margin-bottom:1rem;">
                            Period: <span id="fin-period-display">-</span>
                        </div>
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Amount (USD)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Revenue</strong></td>
                                    <td id="pnl-revenue" class="text-green">0.00</td>
                                </tr>
                                <tr>
                                    <td>(-) Expenses</td>
                                    <td id="pnl-expenses" class="text-red">0.00</td>
                                </tr>
                                <tr style="border-top: 2px solid var(--border);">
                                    <td><strong>Net Profit</strong></td>
                                    <td id="pnl-net" class="font-bold">0.00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Balance Sheet -->
                    <div class="card" style="margin-bottom:0;">
                        <h3>Balance Sheet (Snapshot)</h3>
                        <div style="font-size:0.85rem; color:var(--text-light); margin-bottom:1rem;">
                            As of: <span id="bs-date-display">-</span>
                        </div>
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Value (USD)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Assets</strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td style="padding-left:1.5rem;">Inventory Value (Cost)</td>
                                    <td id="bs-assets">0.00</td>
                                </tr>
                                <tr style="border-top: 2px solid var(--border);">
                                    <td><strong>Total Assets</strong></td>
                                    <td id="bs-total-assets" class="font-bold">0.00</td>
                                </tr>
                                <tr>
                                    <td><strong>Equity</strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td style="padding-left:1.5rem;">Retained Earnings</td>
                                    <td id="bs-equity">0.00</td>
                                </tr>
                                <tr style="border-top: 2px solid var(--border);">
                                    <td><strong>Total Equity</strong></td>
                                    <td id="bs-total-equity" class="font-bold">0.00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>
</div>

<script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbzssnNteju0Tqjzln8Y1vP2YsmR21c5yxOoNJ5wGoWz7VYpfkecJSOdZW9ZVfb-mVhW/exec"; 
    
    let LISTS = {};

    document.addEventListener('DOMContentLoaded', async () => {
        const today = new Date().toISOString().split('T')[0];
        
        // Set dates for all forms
        ['inv-date', 'sales-date', 'exp-date', 'dash-from', 'dash-to', 'fin-from', 'fin-to'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.value = today;
        });

        if (API_BASE.includes("PASTE_")) {
            showToast("Please configure API_URL in index.html", "error");
            return;
        }

        await fetchLists();
        await loadSalesRecent();
    });

    async function apiGet(action, params = {}) {
        const url = new URL(API_BASE);
        url.searchParams.append("action", action);
        Object.keys(params).forEach(k => url.searchParams.append(k, params[k]));
        try {
            const res = await fetch(url);
            return await res.json();
        } catch (e) {
            console.error(e);
            return { ok: false, error: "Network Error" };
        }
    }

    async function apiPost(action, data) {
        try {
            const res = await fetch(API_BASE, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...data, action })
            });
            return await res.json();
        } catch (e) {
            console.error(e);
            return { ok: false, error: e.message };
        }
    }

    function showTab(tabId) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        const btns = Array.from(document.querySelectorAll('.nav-btn'));
        const activeBtn = btns.find(b => b.getAttribute('onclick').includes(tabId));
        if(activeBtn) activeBtn.classList.add('active');
    }

    function showToast(msg, type = 'success') {
        const c = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerHTML = type === 'success' ? `<span>✅</span> ${msg}` : `<span>⚠️</span> ${msg}`;
        c.appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    async function fetchLists() {
        const res = await apiGet("get_lists");
        if (res.ok) {
            LISTS = res.data;
            populateSelect('inv-location', LISTS.LOCATION);
            populateSelect('inv-cat', LISTS.PROD_CAT);
            populateSelect('inv-color', LISTS.PROD_COLOR);
            populateSelect('inv-size', LISTS.PROD_SIZE);
            populateSelect('sales-location', LISTS.LOCATION);
            populateSelect('sales-delivery', LISTS.DELIVERY_COMPANY);
            populateSelect('sales-currency', LISTS.CURRENCY);
            populateSelect('exp-location', LISTS.LOCATION);
            populateSelect('exp-cat', LISTS.EXP_CAT);
            populateSelect('exp-currency', LISTS.CURRENCY);
        } else {
            showToast("Failed to load lists", "error");
        }
    }

    function populateSelect(id, options) {
        const sel = document.getElementById(id);
        if(!sel) return;
        sel.innerHTML = '';
        if(options) {
            options.forEach(opt => {
                const o = document.createElement('option');
                o.value = opt;
                o.innerText = opt;
                sel.appendChild(o);
            });
        }
    }

    // --- Inventory Logic ---
    function calcInvTotal() {
        const rmb = parseFloat(document.querySelector('[name=unit_rmb]').value) || 0;
        const fx = parseFloat(document.querySelector('[name=fx]').value) || 1;
        const qty = parseFloat(document.querySelector('[name=qty]').value) || 0;
        const unitUsd = rmb / fx;
        const totalUsd = unitUsd * qty;
        document.getElementById('inv-unit-usd').value = unitUsd.toFixed(2);
        document.getElementById('inv-total-usd').value = totalUsd.toFixed(2);
    }

    async function handleInventorySubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        const res = await apiPost("inventory_in", data);
        if (res.ok) {
            showToast(res.message);
            e.target.reset();
            document.getElementById('inv-date').value = new Date().toISOString().split('T')[0];
        } else {
            showToast(res.error || "Error saving", "error");
        }
    }

    // --- Sales Logic ---
    function showNewOrderForm() {
        document.getElementById('sales-list-view').style.display = 'none';
        document.getElementById('sales-form-view').style.display = 'block';
        addSalesItemRow();
    }

    function showSalesList() {
        document.getElementById('sales-list-view').style.display = 'block';
        document.getElementById('sales-form-view').style.display = 'none';
        loadSalesRecent();
    }

    function addSalesItemRow() {
        const container = document.getElementById('sales-items-container');
        const div = document.createElement('div');
        div.className = 'items-row';
        div.innerHTML = `
            <select name="item_cat[]" required onchange="updateItemRow(this)">${LISTS.PROD_CAT ? LISTS.PROD_CAT.map(o=>`<option value="${o}">${o}</option>`).join('') : ''}</select>
            <input type="text" name="item_product[]" placeholder="Name" required>
            <select name="item_color[]">${LISTS.PROD_COLOR ? LISTS.PROD_COLOR.map(o=>`<option value="${o}">${o}</option>`).join('') : ''}</select>
            <select name="item_size[]">${LISTS.PROD_SIZE ? LISTS.PROD_SIZE.map(o=>`<option value="${o}">${o}</option>`).join('') : ''}</select>
            <input type="number" name="item_qty[]" placeholder="Qty" min="1" value="1" required oninput="calcSalesTotal()">
            <input type="number" name="item_price[]" placeholder="Price" step="0.01" required oninput="calcSalesTotal()">
            <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove(); calcSalesTotal()">×</button>
        `;
        container.appendChild(div);
    }

    function updateItemRow(select) {}

    function calcSalesTotal() {
        let total = 0;
        const qties = document.getElementsByName('item_qty[]');
        const prices = document.getElementsByName('item_price[]');
        for(let i=0; i<qties.length; i++) total += (parseFloat(qties[i].value)||0) * (parseFloat(prices[i].value)||0);
        document.getElementById('sales-total').value = total.toFixed(2);
    }

    async function handleSalesSubmit(e) {
        e.preventDefault();
        const fd = new FormData(e.target);
        const items = [];
        const cats = fd.getAll('item_cat[]');
        const prods = fd.getAll('item_product[]');
        const colors = fd.getAll('item_color[]');
        const sizes = fd.getAll('item_size[]');
        const qtys = fd.getAll('item_qty[]');
        const prices = fd.getAll('item_price[]');

        for(let i=0; i<cats.length; i++) {
            items.push({
                prod_cat: cats[i], product: prods[i], color: colors[i], size: sizes[i],
                qty: qtys[i], unit_price: prices[i]
            });
        }

        const data = {
            order_date: fd.get('order_date'), location: fd.get('location'),
            customer_name: fd.get('customer_name'), telephone: fd.get('telephone'),
            customer_address: fd.get('customer_address'), delivery_company: fd.get('delivery_company'),
            currency: fd.get('currency'), paid_amount: fd.get('paid_amount'),
            note: fd.get('note'), items: items
        };

        const res = await apiPost("sale_create", data);
        if (res.ok) {
            showToast(res.message);
            showSalesList();
        } else {
            showToast(res.error, "error");
        }
    }

    async function loadSalesRecent() {
        const tbody = document.querySelector('#sales-table tbody');
        tbody.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';
        const res = await apiGet("sales_recent", { limit: 30 });
        if (res.ok) {
            tbody.innerHTML = '';
            res.data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.date.split('T')[0]}</td>
                    <td>${row.order_id}</td>
                    <td>${row.customer_name}</td>
                    <td>${parseFloat(row.total).toFixed(2)}</td>
                    <td>
                        <input type="number" step="0.01" value="${row.paid_amount}" 
                               style="width:80px; padding:4px;" 
                               onchange="updatePayment('${row.order_id}', this.value)">
                        <span class="badge badge-${row.payment_status}">${row.payment_status}</span>
                    </td>
                    <td>
                        <select onchange="updateStatus('${row.order_id}', this.value)" style="padding:4px;">
                            <option value="NEW" ${row.status=='NEW'?'selected':''}>NEW</option>
                            <option value="PREPARING" ${row.status=='PREPARING'?'selected':''}>PREPARING</option>
                            <option value="DELIVERING" ${row.status=='DELIVERING'?'selected':''}>DELIVERING</option>
                            <option value="COMPLETED" ${row.status=='COMPLETED'?'selected':''}>COMPLETED</option>
                            <option value="CANCELLED" ${row.status=='CANCELLED'?'selected':''}>CANCELLED</option>
                        </select>
                    </td>
                    <td><button class="btn btn-secondary btn-sm" onclick="printOrder('${row.order_id}')">Print</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    async function updateStatus(id, status) {
        const res = await apiPost("sale_update_status", { order_id: id, status });
        if(res.ok) showToast("Status updated");
    }

    async function updatePayment(id, amount) {
        const res = await apiPost("sale_update_payment", { order_id: id, paid_amount: amount });
        if(res.ok) { showToast("Payment updated"); loadSalesRecent(); }
    }

    function printOrder(orderId) {
        showToast("Preparing print view...");
        setTimeout(() => window.print(), 1000);
    }

    // --- Expenses Logic ---
    async function handleExpenseSubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        const res = await apiPost("expense_create", data);
        if (res.ok) {
            showToast(res.message);
            e.target.reset();
            document.getElementById('exp-date').value = new Date().toISOString().split('T')[0];
        } else {
            showToast(res.error, "error");
        }
    }

    // --- Dashboard Logic ---
    async function loadDashboard() {
        const from = document.getElementById('dash-from').value;
        const to = document.getElementById('dash-to').value;
        const res = await apiGet("report_summary", { from, to });
        if (res.ok) {
            const d = res.data;
            document.getElementById('kpi-sales').innerText = d.total_sales_usd.toFixed(2);
            document.getElementById('kpi-exp').innerText = d.total_expenses_usd.toFixed(2);
            document.getElementById('kpi-profit').innerText = d.net_profit_usd.toFixed(2);
            const tbody = document.querySelector('#inventory-table tbody');
            tbody.innerHTML = '';
            d.inventory_remaining.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${row.category}</td><td>${row.product}</td><td>${row.color}</td><td>${row.size}</td><td><strong>${row.qty}</strong></td>`;
                tbody.appendChild(tr);
            });
        } else {
            showToast("Failed to load report", "error");
        }
    }

    // --- Financial Reports Logic ---
    async function loadFinancialReports() {
        const from = document.getElementById('fin-from').value;
        const to = document.getElementById('fin-to').value;

        if(!from || !to) {
            showToast("Please select start and end dates", "error");
            return;
        }

        const res = await apiGet("financial_report", { from, to });
        
        if (res.ok) {
            const d = res.data;
            
            // P&L
            document.getElementById('fin-period-display').innerText = `${from} to ${to}`;
            document.getElementById('pnl-revenue').innerText = d.pnl.revenue.toFixed(2);
            document.getElementById('pnl-expenses').innerText = d.pnl.expenses.toFixed(2);
            
            const netProfitEl = document.getElementById('pnl-net');
            netProfitEl.innerText = d.pnl.net_profit.toFixed(2);
            netProfitEl.className = d.pnl.net_profit >= 0 ? 'font-bold text-green' : 'font-bold text-red';

            // Balance Sheet
            document.getElementById('bs-date-display').innerText = to; // As of end date
            document.getElementById('bs-assets').innerText = d.balance_sheet.assets.toFixed(2);
            document.getElementById('bs-total-assets').innerText = d.balance_sheet.assets.toFixed(2);
            
            document.getElementById('bs-equity').innerText = d.balance_sheet.equity.toFixed(2);
            document.getElementById('bs-total-equity').innerText = d.balance_sheet.equity.toFixed(2);
            
            showToast("Financial report updated");
        } else {
            showToast("Failed to load financial report", "error");
        }
    }
</script>
</body>
</html>
